<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯­éŸ³è¯†åˆ«æµ‹è¯•é¡µé¢</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft YaHei", sans-serif;
    }

    body {
      padding: 2rem;
      background-color: #f5f7fa;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background-color: #ffffff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }

    .title {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #eaecef;
    }

    .control-area {
      text-align: center;
      margin-bottom: 2rem;
    }

    .toggle-btn {
      padding: 0.8rem 2rem;
      font-size: 1.1rem;
      color: #ffffff;
      background-color: #3498db;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .toggle-btn.listening {
      background-color: #e74c3c;
    }

    .toggle-btn:hover {
      opacity: 0.9;
    }

    .status-area {
      margin-bottom: 2rem;
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid #3498db;
    }

    .status-title {
      font-size: 1.0rem;
      color: #2c3e50;
      margin-bottom: 0.5rem;
    }

    .status-content {
      font-size: 0.9rem;
      color: #6c757d;
      line-height: 1.6;
    }

    .result-area {
      margin-bottom: 2rem;
    }

    .result-title {
      font-size: 1.0rem;
      color: #2c3e50;
      margin-bottom: 0.8rem;
    }

    .result-box {
      width: 100%;
      min-height: 120px;
      padding: 1rem;
      border: 1px solid #eaecef;
      border-radius: 4px;
      font-size: 0.95rem;
      color: #333333;
      resize: vertical;
      background-color: #f8f9fa;
    }

    .report-area {
      margin-bottom: 1rem;
      text-align: center;
    }

    .report-btn {
      padding: 0.7rem 1.5rem;
      font-size: 1.0rem;
      color: #ffffff;
      background-color: #2ecc71;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 0.5rem;
      transition: background-color 0.3s ease;
    }

    .report-btn:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .report-btn:hover:not(:disabled) {
      opacity: 0.9;
    }

    .hint-text {
      text-align: center;
      font-size: 0.85rem;
      color: #7f8c8d;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">è¯­éŸ³è¯†åˆ«åŠŸèƒ½æµ‹è¯•</h1>

    <!-- æ§åˆ¶åŒºåŸŸï¼šå¼€å¯/å…³é—­è¯­éŸ³ç›‘å¬ -->
    <div class="control-area">
      <button id="toggleListeningBtn" class="toggle-btn">å¼€å¯è¯­éŸ³è¯†åˆ«</button>
    </div>

    <!-- çŠ¶æ€å±•ç¤ºåŒºåŸŸ -->
    <div class="status-area">
      <h3 class="status-title">å½“å‰çŠ¶æ€ï¼š</h3>
      <p id="statusContent" class="status-content">æœªå¼€å¯è¯­éŸ³ç›‘å¬ï¼Œç­‰å¾…æ“ä½œ...</p>
    </div>

    <!-- è¯†åˆ«ç»“æœå±•ç¤ºåŒºåŸŸ -->
    <div class="result-area">
      <h3 class="result-title">è¯­éŸ³è¯†åˆ«ç»“æœï¼š</h3>
      <textarea id="recognitionResultBox" class="result-box" readonly placeholder="è¯­éŸ³è¯†åˆ«ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
    </div>

    <!-- æŠ¥å‘Šç”Ÿæˆä¸ä¸‹è½½åŒºåŸŸ -->
    <div class="report-area">
      <button id="generateReportBtn" class="report-btn" disabled>ç”Ÿæˆè¯†åˆ«æŠ¥å‘Š</button>
      <button id="downloadReportBtn" class="report-btn" disabled>ä¸‹è½½ JSON æŠ¥å‘Š</button>
    </div>

    <!-- æç¤ºä¿¡æ¯ -->
    <p class="hint-text">æç¤ºï¼š1. è¯·å¼€å¯æµè§ˆå™¨éº¦å…‹é£æƒé™ï¼›2. æ”¯æŒä¸­æ–‡ç®€ä½“è¯­éŸ³è¾“å…¥ï¼›3. æŠ¥å‘Šå°†æ¨¡æ‹Ÿä¿å­˜åˆ° data/ ç›®å½•ï¼›4. ä»… Chromeã€Edge ç­‰ç°ä»£æµè§ˆå™¨æ”¯æŒè¯¥åŠŸèƒ½ã€‚</p>
  </div>

  <!-- å¼•å…¥æ ¸å¿ƒ JS æ–‡ä»¶ -->
  <script src="jsrecognition.js"></script>
  <script src="jsreportGenerator.js"></script>

  <!-- é¡µé¢äº¤äº’é€»è¾‘ -->
  <script>
    // è·å–é¡µé¢å…ƒç´ 
    const toggleListeningBtn = document.getElementById('toggleListeningBtn');
    const statusContent = document.getElementById('statusContent');
    const recognitionResultBox = document.getElementById('recognitionResultBox');
    const generateReportBtn = document.getElementById('generateReportBtn');
    const downloadReportBtn = document.getElementById('downloadReportBtn');

    // ç¼“å­˜æœ€ç»ˆæœ‰æ•ˆè¯†åˆ«ç»“æœ
    let finalRecognitionResult = '';

    // 1. ç»‘å®šè¯­éŸ³è¯†åˆ«å®ä¾‹äº‹ä»¶
    const voiceInstance = window.VoiceRecognitionInstance;
    const reportInstance = window.ReportGeneratorInstance;

    // è¯†åˆ«ç»“æœå›è°ƒ
    voiceInstance.onResult((result) => {
      // æ›´æ–°é¡µé¢ç»“æœå±•ç¤º
      recognitionResultBox.value = result.text;
      // ç¼“å­˜æœ€ç»ˆæœ‰æ•ˆç»“æœ
      if (result.isFinal) {
        finalRecognitionResult = result.text;
        // å¯ç”¨æŠ¥å‘Šç”ŸæˆæŒ‰é’®
        generateReportBtn.disabled = false;
        statusContent.innerHTML += `<br>âœ… å·²è·å–æœ€ç»ˆè¯†åˆ«ç»“æœï¼Œå¯ç”ŸæˆæŠ¥å‘Šã€‚`;
      }
    });

    // çŠ¶æ€å˜æ›´å›è°ƒ
    voiceInstance.onStatusChange((statusData) => {
      const statusTextMap = {
        started: 'âœ… è¯­éŸ³ç›‘å¬å·²å¼€å¯ï¼Œæ­£åœ¨ç­‰å¾…è¯­éŸ³è¾“å…¥...',
        stopped: 'âŒ è¯­éŸ³ç›‘å¬å·²å…³é—­ï¼Œåœæ­¢æ¥æ”¶è¯­éŸ³è¾“å…¥ã€‚',
        error: 'âš ï¸ è¯­éŸ³è¯†åˆ«å‡ºç°å¼‚å¸¸ï¼Œå·²åœæ­¢ç›‘å¬ã€‚'
      };

      // æ›´æ–°çŠ¶æ€æ–‡æœ¬
      statusContent.textContent = statusTextMap[statusData.status] || `å½“å‰çŠ¶æ€ï¼š${statusData.status}`;

      // æ›´æ–°æŒ‰é’®æ–‡æœ¬ä¸æ ·å¼
      if (statusData.isListening) {
        toggleListeningBtn.textContent = 'å…³é—­è¯­éŸ³è¯†åˆ«';
        toggleListeningBtn.classList.add('listening');
      } else {
        toggleListeningBtn.textContent = 'å¼€å¯è¯­éŸ³è¯†åˆ«';
        toggleListeningBtn.classList.remove('listening');
      }
    });

    // å¼‚å¸¸å›è°ƒ
    voiceInstance.onError((error) => {
      statusContent.textContent = `âš ï¸ å¼‚å¸¸ï¼š${error.message}`;
      recognitionResultBox.value = `è¯†åˆ«å¤±è´¥ï¼š${error.message}`;
      // ç¦ç”¨æŠ¥å‘Šç›¸å…³æŒ‰é’®
      generateReportBtn.disabled = true;
      downloadReportBtn.disabled = true;
    });

    // 2. ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    // åˆ‡æ¢è¯­éŸ³ç›‘å¬å¼€å…³
    toggleListeningBtn.addEventListener('click', () => {
      voiceInstance.toggleListening();
      // æ¸…ç©ºç»“æœï¼ˆä¿ç•™æœ€ç»ˆç»“æœï¼Œä»…æ¸…ç©ºä¸´æ—¶è¾“å…¥ï¼‰
      if (!voiceInstance.getListeningStatus()) {
        recognitionResultBox.value = finalRecognitionResult;
      } else {
        recognitionResultBox.value = '';
      }
    });

    // ç”Ÿæˆè¯†åˆ«æŠ¥å‘Š
    generateReportBtn.addEventListener('click', async () => {
      try {
        statusContent.textContent += '<br>ğŸ“ æ­£åœ¨ç”Ÿæˆç»“æ„åŒ–æŠ¥å‘Šï¼Œè¯·ç¨å€™...';
        // ç”ŸæˆæŠ¥å‘Š
        const reportData = await reportInstance.generateReport({
          text: finalRecognitionResult,
          isFinal: true,
          isListening: voiceInstance.getListeningStatus()
        });
        // å¯ç”¨ä¸‹è½½æŒ‰é’®
        downloadReportBtn.disabled = false;
        statusContent.textContent += `<br>âœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼ŒæŠ¥å‘ŠIDï¼š${reportData.reportMeta.reportId}`;
      } catch (error) {
        statusContent.textContent += `<br>âš ï¸ æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼š${error.message}`;
        downloadReportBtn.disabled = true;
      }
    });

    // ä¸‹è½½ JSON æŠ¥å‘Š
    downloadReportBtn.addEventListener('click', () => {
      try {
        reportInstance.downloadReport();
        statusContent.textContent += '<br>ğŸ“¥ æŠ¥å‘Šå·²è§¦å‘ä¸‹è½½ï¼Œæ–‡ä»¶æ ¼å¼ä¸º JSONã€‚';
      } catch (error) {
        statusContent.textContent += `<br>âš ï¸ æŠ¥å‘Šä¸‹è½½å¤±è´¥ï¼š${error.message}`;
      }
    });
  </script>
</body>
</html>