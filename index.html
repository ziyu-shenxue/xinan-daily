<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒå®‰å·¥ç¨‹æ—¥æŠ¥ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* ä½ çš„åŸæœ‰æ ·å¼ä¿æŒä¸å˜ */
        body { font-family: "å¾®è½¯é›…é»‘", sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f9f9f9; }
        .form-group { margin: 15px 0; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        textarea { height: 80px; resize: vertical; }
        .table-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 20px 0; }
        .btn { background: #4CAF50; color: white; border: none; padding: 12px 24px; cursor: pointer; border-radius: 8px; font-size: 16px; margin: 5px; }
        .btn:hover { background: #45a049; }
        .voice-btn { background: #ff9800; padding: 8px 12px; font-size: 12px; }
        .voice-btn.recording { background: #f44336; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #report_output { display: none; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .module { margin: 20px 0; padding: 15px; border-left: 4px solid #4CAF50; background: #f8f9fa; }
        .module h3 { margin-top: 0; color: #2c3e50; }
        .sync-status { position: fixed; top: 10px; right: 10px; padding: 8px 16px; background: #2196F3; color: white; border-radius: 20px; display: none; }
    </style>
</head>
<body>
    <h1>ä¸­ååœ£å­¦ä¿®èº«ã€Šå¿ƒå®‰å·¥ç¨‹ã€‹æ—¥æŠ¥ç³»ç»Ÿ</h1>
    
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <h2>ä¸€ã€åŸºæœ¬ä¿¡æ¯</h2>
    <div class="form-group">
        <label>æ—¥æœŸï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ï¼š</label>
        <input type="text" id="date" readonly>
        <button class="btn voice-btn" onclick="startVoiceInput('date')">ğŸ¤ è¯­éŸ³</button>
    </div>
    <!-- å…¶ä»–å­—æ®µä¿æŒä½ çš„åŸç»“æ„ï¼Œæ¯ä¸ªè¾“å…¥æ¡†ååŠ è¯­éŸ³æŒ‰é’® -->

    <!-- æäº¤åŒºåŸŸ -->
    <div style="text-align: center; margin: 30px 0;">
        <button class="btn" onclick="saveAndGenerate()">ä¿å­˜å¹¶ç”Ÿæˆæ—¥æŠ¥</button>
        <button class="btn" onclick="syncToGitHub()">åŒæ­¥åˆ°äº‘ç«¯</button>
        <button class="btn" onclick="exportAsImage()">å¯¼å‡ºä¸ºå›¾ç‰‡</button>
    </div>

    <!-- ç”Ÿæˆçš„æ—¥æŠ¥å±•ç¤ºåŒºåŸŸ -->
    <div id="report_output"></div>

    <!-- åŒæ­¥çŠ¶æ€æç¤º -->
    <div class="sync-status" id="sync_status"></div>

    <script>
        // ==================== 1. è‡ªåŠ¨å¡«å……åŸºç¡€ä¿¡æ¯ ====================
        function initBasicInfo() {
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            const weekdayStr = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][today.getDay()];
            document.getElementById('date').value = dateStr;
            document.getElementById('weekday').value = `æ˜ŸæœŸ${weekdayStr}`;
            
            // ä»æœ¬åœ°å­˜å‚¨è¯»å–å†å²æ•°æ®ï¼Œè‡ªåŠ¨ç”Ÿæˆç¼–å·
            const reports = JSON.parse(localStorage.getItem('xinan_reports') || '[]');
            const nextId = String(reports.length + 1).padStart(3, '0');
            document.getElementById('report_id').value = `00${nextId}`;
        }

        // ==================== 2. è¯­éŸ³è¾“å…¥æ ¸å¿ƒåŠŸèƒ½ ====================
        let recognition = null;
        let currentVoiceField = null;
        
        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«ï¼ˆæµè§ˆå™¨åŸç”ŸAPIï¼Œå®Œå…¨å…è´¹ï¼‰
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                if (currentVoiceField) {
                    // æ™ºèƒ½å¤„ç†ï¼šå¦‚æœæ˜¯æ•°å­—å­—æ®µï¼Œè‡ªåŠ¨æå–æ•°å­—
                    if (currentVoiceField.type === 'number') {
                        const numbers = transcript.match(/\d+/g);
                        if (numbers) currentVoiceField.value = numbers[0];
                    } else {
                        currentVoiceField.value += transcript;
                    }
                }
                stopRecording();
            };
            
            recognition.onerror = () => {
                alert('è¯­éŸ³è¯†åˆ«å‡ºé”™ï¼Œè¯·é‡è¯•');
                stopRecording();
            };
        }
        
        function startVoiceInput(fieldId) {
            if (!recognition) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨Chrome/Edge');
                return;
            }
            
            currentVoiceField = document.getElementById(fieldId);
            const btn = event.target;
            btn.classList.add('recording');
            btn.textContent = 'ğŸ”´ å½•éŸ³ä¸­...';
            
            recognition.start();
        }
        
        function stopRecording() {
            const btn = document.querySelector('.recording');
            if (btn) {
                btn.classList.remove('recording');
                btn.textContent = 'ğŸ¤ è¯­éŸ³';
            }
            if (recognition) recognition.stop();
        }

        // ==================== 3. æ•°æ®ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨å­˜å‚¨ ====================
        function collectFormData() {
            const data = {
                æ—¥æœŸ: document.getElementById('date').value,
                æ˜ŸæœŸ: document.getElementById('weekday').value,
                æ—¥æŠ¥ç¼–å·: document.getElementById('report_id').value,
                // ... å…¶ä»–æ‰€æœ‰å­—æ®µ
                å¿ƒä¼ ç®´è¨€: document.getElementById('xinchuan_proverb').value,
                å¿ƒä¼ èƒ½é‡: document.getElementById('xinchuan_energy').value,
                // åç›®æ•°æ®
                åç›®è·µè¡Œ: CONFIG.ten_items.map(item => ({
                    é¡¹ç›®: item,
                    çŠ¶æ€: document.getElementById(`xinjian_${CONFIG.ten_items.indexOf(item)+1}`).value,
                    åˆ†æ•°: document.getElementById('xinjian_density').value
                })),
                // äº”ç»´æ•°æ®
                äº”ç»´æ•°æ®: {
                    æ²»ç¥æ—¶é•¿: document.getElementById('wudao_1').value,
                    HRV: document.getElementById('wudao_hrv').value,
                    ç¥èšåº¦: document.getElementById('wudao_2').value,
                    æƒ…ç»ªç¨³å®šåº¦: document.getElementById('wudao_3').value,
                    ç¡çœ æ—¶é•¿: document.getElementById('wudao_4').value,
                    äº’åŠ¨æ»¡æ„åº¦: document.getElementById('wudao_5').value
                },
                ä»Šæ—¥æ„Ÿæ‚Ÿ: document.getElementById('summary_feeling').value,
                ç”Ÿæˆæ—¶é—´: new Date().toISOString()
            };
            return data;
        }
        
        function saveAndGenerate() {
            const data = collectFormData();
            
            // ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨
            const reports = JSON.parse(localStorage.getItem('xinan_reports') || '[]');
            reports.push(data);
            localStorage.setItem('xinan_reports', JSON.stringify(reports));
            
            // ç”Ÿæˆæ—¥æŠ¥HTML
            generateReportHTML(data);
            
            alert('æ—¥æŠ¥å·²ä¿å­˜å¹¶ç”Ÿæˆï¼');
        }

        // ==================== 4. ç”Ÿæˆå¯åˆ†äº«çš„æ—¥æŠ¥HTML ====================
        function generateReportHTML(data) {
            const tenItemsHtml = data.åç›®è·µè¡Œ.map(item => 
                `<tr><td>${item.é¡¹ç›®}</td><td>${item.çŠ¶æ€}</td><td>${item.åˆ†æ•°}åˆ†</td></tr>`
            ).join('');
            
            const reportHtml = `
                <div class="module">
                    <h3>ğŸ“… ${data.æ—¥æœŸ} ${data.æ˜ŸæœŸ} | ç¼–å·ï¼š${data.æ—¥æŠ¥ç¼–å·}</h3>
                    <p><strong>æ ¸å¿ƒæ–¹å‘ï¼š</strong>${data.æ ¸å¿ƒä¿®ä¹ æ–¹å‘ || 'æ— '} | <strong>å¤©æ°”ï¼š</strong>${data.å¤©æ°” || 'æ— '}</p>
                </div>
                
                <div class="module">
                    <h3>ä¸€ã€ã€Šå¿ƒä¼ ã€‹ä½“æ‚Ÿ</h3>
                    <p><strong>ç®´è¨€ï¼š</strong>${data.å¿ƒä¼ ç®´è¨€ || 'æœªå¡«å†™'}</p>
                    <p><strong>èƒ½é‡æ„ŸçŸ¥ï¼š</strong>${data.å¿ƒä¼ èƒ½é‡ || 'æ— '}åˆ†</p>
                </div>
                
                <div class="module">
                    <h3>äºŒã€ã€Šå¿ƒè·µã€‹åç›®</h3>
                    <table style="width:100%; border-collapse: collapse;">
                        <tr style="background: #f5f5f5;"><th>é¡¹ç›®</th><th>çŠ¶æ€</th><th>åˆ†æ•°</th></tr>
                        ${tenItemsHtml}
                    </table>
                </div>
                
                <div class="module">
                    <h3>ä¸‰ã€ã€Šäº”ç»´ã€‹é‡åŒ–</h3>
                    <p><strong>æ²»ç¥ï¼š</strong>${data.äº”ç»´æ•°æ®.æ²»ç¥æ—¶é•¿}åˆ†é’Ÿ | HRV: ${data.äº”ç»´æ•°æ®.HRV} | ç¥èšåº¦: ${data.äº”ç»´æ•°æ®.ç¥èšåº¦}åˆ†</p>
                    <p><strong>æ²»å¿ƒï¼š</strong>æƒ…ç»ªç¨³å®šåº¦${data.äº”ç»´æ•°æ®.æƒ…ç»ªç¨³å®šåº¦}åˆ†</p>
                    <p><strong>æ²»èº«ï¼š</strong>ç¡çœ ${data.äº”ç»´æ•°æ®.ç¡çœ æ—¶é•¿}å°æ—¶</p>
                    <p><strong>æ²»ä¸–ï¼š</strong>äº’åŠ¨æ»¡æ„åº¦${data.äº”ç»´æ•°æ®.äº’åŠ¨æ»¡æ„åº¦}åˆ†</p>
                </div>
                
                <div class="module">
                    <h3>å››ã€æ ¸å¿ƒæ„Ÿæ‚Ÿ</h3>
                    <p>${data.ä»Šæ—¥æ„Ÿæ‚Ÿ || 'æœªå¡«å†™'}</p>
                </div>
            `;
            
            document.getElementById('report_output').innerHTML = reportHtml;
            document.getElementById('report_output').style.display = 'block';
        }

        // ==================== 5. å¯¼å‡ºä¸ºå›¾ç‰‡ï¼ˆç”¨äºåˆ†äº«ï¼‰ ====================
        function exportAsImage() {
            const reportDiv = document.getElementById('report_output');
            if (!reportDiv.innerHTML) {
                alert('è¯·å…ˆä¿å­˜å¹¶ç”Ÿæˆæ—¥æŠ¥');
                return;
            }
            
            html2canvas(reportDiv, {
                scale: 2,
                backgroundColor: '#ffffff',
                useCORS: true
            }).then(canvas => {
                // ä¸‹è½½å›¾ç‰‡
                const link = document.createElement('a');
                link.download = `å¿ƒå®‰æ—¥æŠ¥_${document.getElementById('date').value}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                // è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆå¯é€‰ï¼‰
                canvas.toBlob(blob => {
                    navigator.clipboard.write([
                        new ClipboardItem({ 'image/png': blob })
                    ]).then(() => {
                        alert('å›¾ç‰‡å·²ç”Ÿæˆå¹¶å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ç›´æ¥ç²˜è´´åˆ°å¾®ä¿¡/æœ‹å‹åœˆï¼');
                    });
                });
            });
        }

        // ==================== 6. åŒæ­¥åˆ°GitHubï¼ˆå…è´¹äº‘ç«¯å­˜å‚¨ï¼‰ ====================
        const GITHUB_CONFIG = {
            owner: 'ä½ çš„GitHubç”¨æˆ·å',  // ç”¨æˆ·éœ€è¦ä¿®æ”¹è¿™é‡Œ
            repo: 'xinan-daily-reports',
            token: 'ä½ çš„GitHubä»¤ç‰Œ'  // åœ¨GitHub Settings â†’ Developer settings â†’ Personal access tokensç”Ÿæˆ
        };
        
        async function syncToGitHub() {
            const reports = JSON.parse(localStorage.getItem('xinan_reports') || '[]');
            if (reports.length === 0) {
                alert('æ²¡æœ‰æ•°æ®éœ€è¦åŒæ­¥');
                return;
            }
            
            showSyncStatus('æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...');
            
            try {
                const dateStr = new Date().toISOString().split('T')[0];
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(reports, null, 2))));
                
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/data/${dateStr}.json`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `åŒæ­¥æ—¥æŠ¥æ•°æ® - ${dateStr}`,
                        content: content
                    })
                });
                
                if (response.ok) {
                    showSyncStatus('åŒæ­¥æˆåŠŸï¼', 'success');
                    // ç”Ÿæˆå¯åˆ†äº«çš„é“¾æ¥
                    const shareUrl = `https://${GITHUB_CONFIG.owner}.github.io/${GITHUB_CONFIG.repo}/view.html?date=${dateStr}`;
                    alert(`åŒæ­¥å®Œæˆï¼å¯åˆ†äº«æ­¤é“¾æ¥ç»™ä»–äººæŸ¥çœ‹ï¼ˆåŒ¿åï¼‰ï¼š\n${shareUrl}`);
                } else {
                    throw new Error('åŒæ­¥å¤±è´¥');
                }
            } catch (error) {
                showSyncStatus('åŒæ­¥å¤±è´¥ï¼Œç¨åé‡è¯•', 'error');
                console.error(error);
            }
        }
        
        function showSyncStatus(message, type = 'normal') {
            const status = document.getElementById('sync_status');
            status.textContent = message;
            status.style.display = 'block';
            status.style.background = type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        // ==================== 7. é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ– ====================
        window.onload = function() {
            initBasicInfo();
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªåŒæ­¥çš„æ•°æ®
            const reports = JSON.parse(localStorage.getItem('xinan_reports') || '[]');
            if (reports.length > 0) {
                const lastReport = reports[reports.length - 1];
                const lastDate = new Date(lastReport.æ—¥æœŸ);
                const today = new Date();
                if (lastDate.toDateString() === today.toDateString()) {
                    generateReportHTML(lastReport); // è‡ªåŠ¨æ˜¾ç¤ºä»Šå¤©çš„æ—¥æŠ¥
                }
            }
        };
    </script>
</body>
</html>